# 感谢
- [CyC2018/CS-Notes](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.md)

---
# 目录
#### [1.基础知识](#1-基础知识)
#### [2.IP](#2-IP)
#### [3.TCP](#3-TCP)
#### [4.UDP](#4-UDP)
#### [5.SCTP](#4-SCTP)

---


---
# 1. 基础知识
[^_^]:
	以下是引用
	[OSI_tcp_five]: https://github.com/CyC2018/CS-Notes/blob/master/pics/426df589-6f97-4622-b74d-4a81fcb1da8e.png
	[osi]: /pics/osi7.png
	[tcp_ip]: /pics/tcpip.png
	[tcp_ip_protocol]: https://github.com/CyC2018/CS-Notes/raw/master/pics/d4eef1e2-5703-4ca4-82ab-8dda93d6b81f.png


## 1.1 计算机网络体系结构
![OSI_tcp_five]


各层次含义为：

![osi]

- TCP/IP 协议层的主要协议

![tcp_ip_protocol]

![tcp_ip]


## 1.2 物理层

通信方式：

- 单工通信：单向传输
- 半双工通信：双向交替传输
- 全双工通信：双向同时传输


## 1.3 数据链路层
[^_^]:
	以下是引用
	[数据链路层详解]: https://blog.csdn.net/xiongqiaochu/article/details/65653132
	[数据链路层]: https://blog.csdn.net/xiongqiaochu/article/details/65653132
	[frame]: /pics/frame.png
	[pppframe]: /pics/pppframe.png
	[macFrame]: /pics/macframe.png
	
- 实现网卡接口的网络驱动程序，处理数据在物理媒介上的传输。
- 两个常用的协议：
	- ARP(Address Resolve Protocol): 地址解析协议
	- RARP(Reverse Address Resolve Protocol): 逆地址解析协议
	- 主要实现IP地址和及机器物理地址（MAC地址）之间的转换
	
#### 信道
1. 点对点信道，一对一的通信方式 
2. 广播信道，一对多的广播通信方式

- 通常使用的多是点对点的信道
	- HDLC协议： 面向比特流的
	- PPP协议： 面向字节流的
	- HDLC在控制字段中提供了可靠的确认机制，因此它可以实现可靠传输，而PPP则不提供可靠传输
	- 全世界使用得最多的数据链路层协议是PPP协议

#### 帧
- [数据链路层]

![frame]

#### 以太网帧

以太网帧格式：
- 类型 ：标记上层使用的协议；
- 数据 ：长度在46-1500 之间，如果太小则需要填充；
- FCS ：帧检验序列，使用的是 CRC 检验方法；
- 前同步码 ：只是为了计算 FCS 临时加入的，计算结束之后会丢弃。

![macFrame]

- 帧部：18 字节
- MTU:46-1500 字节；
- 总长：64 ~1518 字节

#### ppp 帧

PPP 的帧格式：
- F 字段为帧的定界符
- A 和 C 字段暂时没有意义
- FCS 字段是使用 CRC 的检验序列
- 信息部分的长度不超过 1500


![pppframe]



- ppp属于广域网范畴，MAC是局域网范畴;
- 按实际情况和环境就选用不同的协议，ppp支持的网络结构只能是点对点，mac支持多点对多点。
- 以太网中用mac，远程的话就用ppp（如ADSL拨号，就是基于ppp的）。


#### 信道复用
- 频分复用
频分复用的所有主机在相同的时间占用不同的频率带宽资源。

- 时分复用
时分复用的所有主机在不同的时间占用相同的频率带宽资源。

使用频分复用和时分复用进行通信，在通信的过程中主机会一直占用一部分信道资源。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。

- 统计时分复用

是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。

- 波分复用

光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。


- 码分复用


#### CSMA/CD 协议
CSMA/CD 表示载波监听多点接入 / 碰撞检测。

- **多点接入** ：说明这是总线型网络，许多主机以多点的方式连接到总线上。
- **载波监听** ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
- **碰撞检测** ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。
记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为**争用期** 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用 **截断二进制指数退避算法** 来确定。从离散的整数集合 {0, 1, .., (2k-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。

![](https://github.com/CyC2018/CS-Notes/raw/master/pics/5aa82b89-f266-44da-887d-18f31f01d8ef.png)



## 1.4 网络层

[^_^]:
	以下是引用
	[icmp]: /pics/icmp.png
	[icmp详解]: https://blog.csdn.net/jxch____/article/details/78876995

	
- 实现数据包的选路和转发。
- 网络层的主要协议：
	- IP协议
	- ICMP协议（Internet Control Message Protocol, 因特网控制报文协议）
	- IGMP协议（Internet Group Management Protocol, 网际组管理协议）

#### ICMP协议

- 参考: [icmp详解]

- 格式

![icmp]


- 分类
	- ICMP差错报告报文
	- ICMP询问报文
	
![](https://github.com/CyC2018/CS-Notes/raw/master/pics/aa29cc88-7256-4399-8c7f-3cf4a6489559.png)


## 1.5 传输层


- 传送层提供端到端的通信，传输层只关注起始端和目的端，而不在乎数据包的中转过程。
- 传输层的主要协议：
	- TCP协议：提供**可靠**的，**面向连接**的和**基于流**的服务。
	- UDP协议：提供**不可靠的**，**无连接**的和**基于数据报**的服务。
	- SCTP协议
	

	
## 1.6 应用层

[^_^]:
	以下是引用
	[pic_frame_encap]: /pics/frame_encap.png
	[pic_macframe_encap]: /pics/macframe_encap.jpg
	[pic_frame_demulti]: /pics/frame_demulti.png




- 应用层负责处理应用程序的逻辑，在用户空间实现。
- 数据链路层，网络层和传输层负责处理网络通信细节，在内核空间实现；

- 应用层的协议有很多：
	- ping:应用程序，不是协议，利用ICMP报文检测**网络连接**， 是调试网络环境的工具。
	- telnet:远程登录协议。
	- OSPF(Open Shortest Path First, 开放最短路径优先）：协议是一种动态路由更新协议，用于路由器之间的通信。
	- DNS(Domain Name Service ，域名服务)：协议提供机器域名和IP地址的转换。
	
- 应用程序可以跳过传送层直接使用网络层的服务，如ping 程序 和 OSPF协议。
- 应用程序（或者协议）既可以使用TCP服务，也可以使用UDP服务，如DNS协议。
	
	
#### 封装

![pic_frame_encap]

帧的最大传输单元（MTU）通常受到网络类型的影响。过长的IP数据报被分片(fragment)传输。

![pic_macframe_encap]

#### 分用(demultiplexing)
- 帧到达主机，沿着协议栈自底向上依次传递，各层协议处理帧的相关头部信息，获取所需要的信息，最终将处理后的帧交给目标程序，这个过程称为分用。
- 分用是靠头部信息中的类型字段实现的。

![pic_frame_demulti]

- IP,ARP,RARP协议都是使用帧传递数据，帧含有**两字节的类型**来区分协议：
	- IP: 0x800
	- ARP:0x806
	- RARP:0x835
	
- TCP , UDP 协议使用端口号来区分上层应用程序。


# 2. IP协议

[^_^]:
	以下是引用
	[pic_ipv4]: /pics/ipv4.png
	
	
#### 特点
- **无状态**、**无连接**、 **不可靠**的服务。
- **无状态**：
	- IP通信对方不同步传输数据的状态信息，所有IP数据报的发送，传输和接收都是独立，没有上下文关系的。
	- 缺点：无法处理乱序和重复的IP数据报。
	- 优点： 高效，简单。
	
- **无连接**：
	- 指的是IP通信双方都不长久地维持对方的任何信息。
	- 每次发送都必须指定目的地址。
	
- **不可靠**：
	- IP协议不能保证IP数据报准确到达接收端，，只是承诺最大努力。

#### IPv4头部结构

- 长度通常为20字节，除非包含可变长的选项部分。

![pic_ipv4]

1. 4位版本号： 
	- IPv4: 值为4
2. 4位头部长度：（4位最大1111，表示15）IP长度最长60字节
3. 8位服务类型(Type Of Service ,TOS)： 包含一个3位的优先权字段(已被忽略)，4位的TOS字段和1位保留字段(必须置0)
	- 最小延时
	- 最大吞吐量
	- 最高可靠性
	- 最小费用（这几个四位TOS字段中，最多只有一个能置为0）
4. 16位总长度：IP数据报的长度，最大长度为：65535（2^16 -1）字节。
5. 16位标识： 唯一地标识主机发送的每一个数据报，初始值系统随机生成，每发送一个，其值加1。数据报分片时，同一数据报的分片标识一样。
6. 3位标志：
	- 第一位保留
	- 第二位(Don't Fragment,DF): 禁止分片，如果长度超过MTU，IP模块丢弃这个数据报返回一个ICMP差错报文。
	- 第三为(More Fragment, MF): 更多分片，除了数据报最后一个分片，其他分片都要置1.

7. 13位片偏移： 分片相对原始数据报（仅指数据部分）开始处的偏移。
8. 8位生存时间(Time to Live, TTL): 数据报达到目的地之前允许经过的路由器跳数。（常见的值为64）
9. 8位协议：用来区分上层协议
	- ICMP : 1
	- TCP: 6
	- UDP: 17
10. 16位头部校验和： 发送端填充，接收端使用CRC算法检验(**仅校验头部**);
11. 最后两个字段使用表示发送端和目的端的IP地址。

12. 最后一个选项字段是可变长的可选信息，最多40字节


#### IP 分片

![](https://github.com/CyC2018/CS-Notes/blob/master/pics/23ba890e-e11c-45e2-a20c-64d217f83430.png)


# 3. TCP

# 4. UDP

# 5. SCTP




# 6. ARP协议

[^_^]:
	以下是引用
	[pic_arp]: /pics/arp.png
	
ARP协议实现 任意网络层地址到任意物理地址的转换
工作原理：
- 主机向自己的网络广播一个ARP请求，该请求包含目标机器的网络地址。
- 此网络上的其他机器收到这个请求， 但只有被请求的机器才会回应一个ARP应答，其中包含自己的物理地址。
	
#### ARP的格式

![pic_arp]

1. 硬件类型： 定义物理地址类型，值为1表示MAC地址
2. 协议类型： 表示映射的协议地址类型， 它的值为0x800,表示IP地址。
3. 硬件地址长度和协议地址长度： 单位是字节。
	- 对mac地址来说：6
	- 对IP(v4)地址来说：4
4. 操作： 
	- ARP请求(值为1)
	- ARP应答(值为2)
	- RARP请求(值为3)
	- RARP应答(值为4)
5. 最后四个字段指定双方的以太网地址和IP地址。

从上面看出，ARP的长度为**28字节**。
	
	
# 7. DNS 协议

[^_^]:
	以下是引用
	[pic_dns]: /pics/dns.png


#### dns 查询和应答报文

![pic_dns]

- 16位标识字段用于标记一对DNS查询和应答，以此1区分一个DNS应答是哪个DNS查询的回应。
- 16位标志字段用于协商具体的通信方式和反馈通信状态。
- 接下来四个字段指出DNS报文的资源记录数目。
	- 查询报文：包含一个查询问题，应答资源记录数、授权资源记录数、额外的资源记录数则为0
	- 应答报文：应答资源记录数至少为1，授权资源记录和额外资源记录可为0 或非0
	
	





